name: Update Nextflow-approved image's layers
on:
  workflow_dispatch:
  push:
    # branches: master
    paths:
      - 'nextflow-base-images/**' #Runs every time this folder gets updated
      - '.github/workflows/get_layer_info_for_nf_imgs.yml'
  schedule:
    - cron: '0 0 * * 0'  # Run at midnight UTC every Sunday

jobs:
  get_image_layers:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: store/branch_to_track_nf_img_layers

      - name: Pull HTTP Response
        run: |
          # url_list=$(curl -s "https://raw.githubusercontent.com/uc-cdis/containers/master/nextflow-base-images/allowed_base_images.txt")
          url_list=$(curl -s "https://raw.githubusercontent.com/uc-cdis/containers/feat/automate_nf_base_images_build/nextflow-base-images/allowed_base_images.txt")
          TOKEN=$(curl -s https://public.ecr.aws/token/ | jq -r .token)
          layer_json="{}"
          while IFS= read -r image_url; do
              manifest_url=$(echo ${image_url} | sed 's|public\.ecr\.aws/\(.*\):\(.*\)|https://public.ecr.aws/v2/\1/manifests/\2|')
              tag_name=$(echo ${image_url} | sed 's|\(.*\):\(.*\)|\2|')
              echo $manifest_url, $tag_name
              response=$(curl -s -H "Authorization: Bearer $TOKEN" $manifest_url | jq "[.layers[].digest]")
              layer_json=$(echo "$layer_json" | jq --arg key "$image_url" --argjson extracted "$response" '. + { ($key): $extracted }')
          done <<< "$url_list"
          echo "$layer_json" > nextflow-base-images/approved_img_layers.json
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update approved_img_layers.json"
          branch: store/branch_to_track_nf_img_layers
          create_branch: true
          commit_options: '-a'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
