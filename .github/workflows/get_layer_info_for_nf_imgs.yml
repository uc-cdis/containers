name: Update Nextflow-approved image's layers
on:
  push:
    branches: master
    paths:
      - 'nextflow-base-images/allowed_base_images.txt' #Runs every time this file is updated
  schedule:
    - cron: '0 0 * * 0'  # Run at midnight every Sunday

jobs:
  get_image_layers:
    runs-on: ubuntu-latest

    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Pull HTTP Response
        run: |
          url_list=$(curl -s "https://raw.githubusercontent.com/uc-cdis/containers/master/nextflow-base-images/allowed_base_images.txt")
          TOKEN=$(curl -s https://public.ecr.aws/token/ | jq -r .token)
          layer_json="{}"
          while IFS= read -r image_url; do
              manifest_url=$(echo ${image_url} | sed 's|public\.ecr\.aws/\(.*\):\(.*\)|https://public.ecr.aws/v2/\1/manifests/\2|')
              tag_name=$(echo ${image_url} | sed 's|\(.*\):\(.*\)|\2|')
              response=$(curl -s -H "Authorization: Bearer $TOKEN" $manifest_url | jq "[.layers[].digest]")
              layer_json=$(echo "$layer_json" | jq --arg key "$tag_name" --argjson extracted "$response" '. + { ($key): $extracted }')
          done <<< "$url_list"
          echo "$layer_json" > nextflow-base-images/response.json
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update response.json"
          branch: store/branch_to_track_nf_img_layers
          create_branch: true
          commit_options: '-a'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
